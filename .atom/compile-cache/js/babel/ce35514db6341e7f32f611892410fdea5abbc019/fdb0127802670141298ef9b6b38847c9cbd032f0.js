var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _formatJs = require('./format.js');

'use babel';

var server_config = require('./../config/server-schema.json');
var folder_config = require('./../config/folder-schema.json');

var atom = global.atom;
var FileSystem = require('fs-plus');
var Electron = require('electron');
var XMLParser = require('xml-js');
var Storage = require('./storage.js');

var Import = (function () {
  function Import() {
    _classCallCheck(this, Import);

    var self = this;

    self.onError = function (error) {};
    self.onWarning = function (error) {};
    self.onFinished = function (statistic) {};
  }

  _createClass(Import, [{
    key: 'import',
    value: function _import() {
      var self = this;

      Electron.remote.dialog.showOpenDialog(null, { title: 'Select file to import', defaultPath: Electron.remote.app.getPath("desktop"), buttonLabel: 'Import', filters: [{ name: 'All Files', extensions: ['*'] }, { name: 'FileZilla', extensions: ['xml'] }, { name: 'PHP Storm', extensions: ['xml'] }, { name: 'Remote-Ftp', extensions: ['ftpconfig'] }], properties: ['openFile', 'showHiddenFiles'] }, function (filePaths, bookmarks) {
        if (filePaths) {
          filePaths.forEach(function (filePath, index) {
            if (filePath.toLowerCase().endsWith('.xml') || filePath.toLowerCase().endsWith('.ftpconfig')) {
              FileSystem.readFile(filePath, function (error, data) {
                if (error) {
                  self.onError(new Error('Opening file failed'));
                } else {
                  if (filePath.toLowerCase().endsWith('.xml')) {
                    try {
                      var json = XMLParser.xml2js(data, { compact: true });
                      if (typeof json['FileZilla3'] !== 'undefined') {
                        self.onFinished(self.importFileZilla3(json['FileZilla3']['Servers'], null));
                      } else if (typeof json['application']['component']['option'] !== 'undefined') {
                        self.onFinished(self.importPHPStorm(json['application']['component']['option']['webServer'], null));
                      }
                    } catch (error) {
                      self.onError(new Error('Parsing file failed'));
                    }
                  } else if (filePath.toLowerCase().endsWith('.ftpconfig')) {
                    try {
                      var json = JSON.parse(data);
                      self.onFinished(self.importFtpConfig(json));
                    } catch (error) {
                      self.onError(new Error('Parsing file failed'));
                    }
                  }
                }
              });
            } else {
              self.onError(new Error('Unknown file format'));
            }
          });
        } else {
          self.onWarning(new Error('No import file has not been selected'));
        }
      });
    }
  }, {
    key: 'importFileZilla3',
    value: function importFileZilla3(data, parent) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;
      var createdFolders = 0;

      if (typeof data['Server'] !== 'undefined') {
        if (!Array.isArray(data['Server'])) {
          data['Server'] = [data['Server']];
        }
        data['Server'].forEach(function (serverData, index) {
          var newconfig = Storage.getServerByName(serverData['Name']['_text']);
          var newServer = true;

          if (typeof newconfig === 'undefined') {
            newconfig = JSON.parse(JSON.stringify(server_config));
            createdServers++;
          } else {
            updatedServers++;
            newServer = false;
          }

          newconfig.name = serverData['Name']['_text'];
          newconfig.host = serverData['Host']['_text'];
          if (typeof serverData['Port'] !== 'undefined') newconfig.port = serverData['Port']['_text'];
          if (typeof serverData['User'] !== 'undefined') newconfig.user = serverData['User']['_text'];
          if (typeof serverData['Pass'] !== 'undefined') {
            if (serverData['Pass']['_attributes']['encoding'] == 'base64') {
              newconfig.password = Buffer.from(serverData['Pass']['_text'], serverData['Pass']['_attributes']['encoding']).toString();
            } else if (serverData['Pass']['_attributes']['encoding'] == 'crypt') {
              atom.notifications.addWarning('Not implemented import from FileZilla!', {
                detail: "Filezilla import with crypted password has not been implemented! Saved empty password for " + newconfig.name + "!",
                dismissable: true
              });
            } else if (serverData['Pass']['_attributes']['encoding'] == 'plain') {
              newconfig.password = serverData['Pass']['_text'], serverData['Pass']['_attributes']['encoding'];
            } else {
              atom.notifications.addWarning('Not recognized encoding method for password!', {
                detail: "Couldn't recognize password type for server " + newconfig.name + " in FileZilla import file. Saved empty password.",
                dismissable: true
              });
            }
          }
          newconfig.sftp = serverData['Protocol']['_text'] == '1';
          newconfig.remote = serverData['RemoteDir']['_text'] || '';

          // Convert FileZilla path
          if (newconfig.remote.length > 0) {
            var parts = newconfig.remote.split(' ');
            var segments = ['/'];

            // Remove type and stop
            var type = parts.shift();
            var _stop = parts.shift();

            // parse segments
            while (parts.length > 0) {
              var segmentLength = parts.shift();
              segments.push(parts.shift());
            }
            newconfig.remote = (0, _formatJs.normalize)(segments.join('/'));
          }

          newconfig.parent = parent;
          if (newServer) {
            Storage.addServer(newconfig);
          }
        });
      }

      if (typeof data['Folder'] !== 'undefined') {
        if (!Array.isArray(data['Folder'])) {
          data['Folder'] = [data['Folder']];
        }
        data['Folder'].forEach(function (folderData, index) {
          var newconfig = Storage.getFolderByName(folderData['_text']);
          if (typeof newconfig === 'undefined') {
            newconfig = JSON.parse(JSON.stringify(folder_config));
            newconfig.name = folderData['_text'];
            newconfig.parent = parent;
            Storage.addFolder(newconfig);
            createdFolders++;
          }
          var imported = self.importFileZilla3(folderData, newconfig.id);
          createdServers += imported.createdServers;
          updatedServers += imported.updatedServers;
          createdFolders += imported.createdFolders;
        });
      }

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: createdFolders };
    }
  }, {
    key: 'importFtpConfig',
    value: function importFtpConfig(data) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;

      var name = (typeof data['user'] !== 'undefined' ? data['user'] + '@' : '') + data['host'];
      var newconfig = Storage.getServerByName(name);
      if (typeof newconfig === 'undefined') {
        newconfig = JSON.parse(JSON.stringify(server_config));
        createdServers++;
      } else {
        updatedServers++;
      }
      newconfig.name = name;
      newconfig.host = data['host'];
      if (typeof data['port'] !== 'undefined') newconfig.port = data['port'];
      if (typeof data['user'] !== 'undefined') newconfig.user = data['user'];
      if (typeof data['pass'] !== 'undefined') newconfig.password = data['pass'];
      newconfig.sftp = data['protocol'] == 'sftp';
      newconfig.remote = data['remote'];
      if (createdServers > 0) {
        Storage.addServer(newconfig);
      }

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: 0 };
    }
  }, {
    key: 'importPHPStorm',
    value: function importPHPStorm(data) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;

      data.forEach(function (serverData, index) {
        var newconfig = Storage.getServerByName(serverData['_attributes']['name']);
        var newServer = true;
        if (typeof newconfig === 'undefined') {
          newconfig = JSON.parse(JSON.stringify(server_config));
          createdServers++;
        } else {
          updatedServers++;
          newServer = false;
        }
        newconfig.name = serverData['_attributes']['name'];
        newconfig.host = serverData['fileTransfer']['_attributes']['host'];
        if (typeof serverData['fileTransfer']['_attributes']['port'] !== 'undefined') newconfig.port = serverData['fileTransfer']['_attributes']['port'];
        newconfig.sftp = serverData['fileTransfer']['_attributes']['accessType'] == 'SFTP';
        newconfig.remote = serverData['fileTransfer']['_attributes']['rootFolder'] || '';
        if (newServer) {
          Storage.addServer(newconfig);
        }
      });

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: 0 };
    }
  }]);

  return Import;
})();

module.exports = Import;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuYW5tYXlqYWluLy5hdG9tL3BhY2thZ2VzL2Z0cC1yZW1vdGUtZWRpdC9saWIvaGVscGVyL2ltcG9ydC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O3dCQUUwQixhQUFhOztBQUZ2QyxXQUFXLENBQUM7O0FBSVosSUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7QUFDaEUsSUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7O0FBRWhFLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDekIsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3RDLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQyxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDcEMsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOztJQUVsQyxNQUFNO0FBQ0MsV0FEUCxNQUFNLEdBQ0k7MEJBRFYsTUFBTTs7QUFFUixRQUFNLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWxCLFFBQUksQ0FBQyxPQUFPLEdBQUcsVUFBQyxLQUFLLEVBQUssRUFBRyxDQUFDO0FBQzlCLFFBQUksQ0FBQyxTQUFTLEdBQUcsVUFBQyxLQUFLLEVBQUssRUFBRyxDQUFDO0FBQ2hDLFFBQUksQ0FBQyxVQUFVLEdBQUcsVUFBQyxTQUFTLEVBQUssRUFBRyxDQUFDO0dBQ3RDOztlQVBHLE1BQU07O1dBU0osbUJBQUc7QUFDUCxVQUFNLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWxCLGNBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFT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QUM7QUFDbkQsaUJBQVMsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ25FLFlBQUksT0FBTyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssV0FBVyxFQUMxRSxTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyRSxpQkFBUyxDQUFDLElBQUksR0FBSSxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksTUFBTSxBQUFDLENBQUM7QUFDckYsaUJBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNqRixZQUFJLFNBQVMsRUFBRTtBQUNiLGlCQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzlCO09BQ0YsQ0FBQyxDQUFDOztBQUVILGFBQU8sRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLENBQUMsRUFBRSxDQUFDO0tBQzlGOzs7U0EzTUcsTUFBTTs7O0FBNk1aLE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDIiwiZmlsZSI6Ii9ob21lL2FuYW5tYXlqYWluLy5hdG9tL3BhY2thZ2VzL2Z0cC1yZW1vdGUtZWRpdC9saWIvaGVscGVyL2ltcG9ydC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgeyBub3JtYWxpemUgfSBmcm9tICcuL2Zvcm1hdC5qcyc7XG5cbmNvbnN0IHNlcnZlcl9jb25maWcgPSByZXF1aXJlKCcuLy4uL2NvbmZpZy9zZXJ2ZXItc2NoZW1hLmpzb24nKTtcbmNvbnN0IGZvbGRlcl9jb25maWcgPSByZXF1aXJlKCcuLy4uL2NvbmZpZy9mb2xkZXItc2NoZW1hLmpzb24nKTtcblxuY29uc3QgYXRvbSA9IGdsb2JhbC5hdG9tO1xuY29uc3QgRmlsZVN5c3RlbSA9IHJlcXVpcmUoJ2ZzLXBsdXMnKTtcbmNvbnN0IEVsZWN0cm9uID0gcmVxdWlyZSgnZWxlY3Ryb24nKTtcbmNvbnN0IFhNTFBhcnNlciA9IHJlcXVpcmUoJ3htbC1qcycpO1xuY29uc3QgU3RvcmFnZSA9IHJlcXVpcmUoJy4vc3RvcmFnZS5qcycpO1xuXG5jbGFzcyBJbXBvcnQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgIHNlbGYub25FcnJvciA9IChlcnJvcikgPT4geyB9O1xuICAgIHNlbGYub25XYXJuaW5nID0gKGVycm9yKSA9PiB7IH07XG4gICAgc2VsZi5vbkZpbmlzaGVkID0gKHN0YXRpc3RpYykgPT4geyB9O1xuICB9XG5cbiAgaW1wb3J0KCkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgRWxlY3Ryb24ucmVtb3RlLmRpYWxvZy5zaG93T3BlbkRpYWxvZyhudWxsLCB7IHRpdGxlOiAnU2VsZWN0IGZpbGUgdG8gaW1wb3J0JywgZGVmYXVsdFBhdGg6IEVsZWN0cm9uLnJlbW90ZS5hcHAuZ2V0UGF0aChcImRlc2t0b3BcIiksIGJ1dHRvbkxhYmVsOiAnSW1wb3J0JywgZmlsdGVyczogW3sgbmFtZTogJ0FsbCBGaWxlcycsIGV4dGVuc2lvbnM6IFsnKiddIH0sIHsgbmFtZTogJ0ZpbGVaaWxsYScsIGV4dGVuc2lvbnM6IFsneG1sJ10gfSwgeyBuYW1lOiAnUEhQIFN0b3JtJywgZXh0ZW5zaW9uczogWyd4bWwnXSB9LCB7IG5hbWU6ICdSZW1vdGUtRnRwJywgZXh0ZW5zaW9uczogWydmdHBjb25maWcnXSB9XSwgcHJvcGVydGllczogWydvcGVuRmlsZScsICdzaG93SGlkZGVuRmlsZXMnXSB9LCAoZmlsZVBhdGhzLCBib29rbWFya3MpID0+IHtcbiAgICAgIGlmIChmaWxlUGF0aHMpIHtcbiAgICAgICAgZmlsZVBhdGhzLmZvckVhY2goKGZpbGVQYXRoLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGlmIChmaWxlUGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcueG1sJykgfHwgZmlsZVBhdGgudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnLmZ0cGNvbmZpZycpKSB7XG4gICAgICAgICAgICBGaWxlU3lzdGVtLnJlYWRGaWxlKGZpbGVQYXRoLCBmdW5jdGlvbiAoZXJyb3IsIGRhdGEpIHtcbiAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5vbkVycm9yKG5ldyBFcnJvcignT3BlbmluZyBmaWxlIGZhaWxlZCcpKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZVBhdGgudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnLnhtbCcpKSB7XG4gICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uID0gWE1MUGFyc2VyLnhtbDJqcyhkYXRhLCB7IGNvbXBhY3Q6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YganNvblsnRmlsZVppbGxhMyddICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgIHNlbGYub25GaW5pc2hlZChzZWxmLmltcG9ydEZpbGVaaWxsYTMoanNvblsnRmlsZVppbGxhMyddWydTZXJ2ZXJzJ10sIG51bGwpKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YganNvblsnYXBwbGljYXRpb24nXVsnY29tcG9uZW50J11bJ29wdGlvbiddICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgIHNlbGYub25GaW5pc2hlZChzZWxmLmltcG9ydFBIUFN0b3JtKGpzb25bJ2FwcGxpY2F0aW9uJ11bJ2NvbXBvbmVudCddWydvcHRpb24nXVsnd2ViU2VydmVyJ10sIG51bGwpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5vbkVycm9yKG5ldyBFcnJvcignUGFyc2luZyBmaWxlIGZhaWxlZCcpKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbGVQYXRoLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5mdHBjb25maWcnKSkge1xuICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYub25GaW5pc2hlZChzZWxmLmltcG9ydEZ0cENvbmZpZyhqc29uKSk7XG4gICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBzZWxmLm9uRXJyb3IobmV3IEVycm9yKCdQYXJzaW5nIGZpbGUgZmFpbGVkJykpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlbGYub25FcnJvcihuZXcgRXJyb3IoJ1Vua25vd24gZmlsZSBmb3JtYXQnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbGYub25XYXJuaW5nKG5ldyBFcnJvcignTm8gaW1wb3J0IGZpbGUgaGFzIG5vdCBiZWVuIHNlbGVjdGVkJykpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaW1wb3J0RmlsZVppbGxhMyhkYXRhLCBwYXJlbnQpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICBsZXQgY3JlYXRlZFNlcnZlcnMgPSAwO1xuICAgIGxldCB1cGRhdGVkU2VydmVycyA9IDA7XG4gICAgbGV0IGNyZWF0ZWRGb2xkZXJzID0gMDtcblxuICAgIGlmICh0eXBlb2YgZGF0YVsnU2VydmVyJ10gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YVsnU2VydmVyJ10pKSB7XG4gICAgICAgIGRhdGFbJ1NlcnZlciddID0gW2RhdGFbJ1NlcnZlciddXTtcbiAgICAgIH1cbiAgICAgIGRhdGFbJ1NlcnZlciddLmZvckVhY2goKHNlcnZlckRhdGEsIGluZGV4KSA9PiB7XG4gICAgICAgIGxldCBuZXdjb25maWcgPSBTdG9yYWdlLmdldFNlcnZlckJ5TmFtZShzZXJ2ZXJEYXRhWydOYW1lJ11bJ190ZXh0J10pO1xuICAgICAgICBsZXQgbmV3U2VydmVyID0gdHJ1ZTtcblxuICAgICAgICBpZiAodHlwZW9mIG5ld2NvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBuZXdjb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNlcnZlcl9jb25maWcpKTtcbiAgICAgICAgICBjcmVhdGVkU2VydmVycysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHVwZGF0ZWRTZXJ2ZXJzKys7XG4gICAgICAgICAgbmV3U2VydmVyID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdjb25maWcubmFtZSA9IHNlcnZlckRhdGFbJ05hbWUnXVsnX3RleHQnXTtcbiAgICAgICAgbmV3Y29uZmlnLmhvc3QgPSBzZXJ2ZXJEYXRhWydIb3N0J11bJ190ZXh0J107XG4gICAgICAgIGlmICh0eXBlb2Ygc2VydmVyRGF0YVsnUG9ydCddICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgICBuZXdjb25maWcucG9ydCA9IHNlcnZlckRhdGFbJ1BvcnQnXVsnX3RleHQnXTtcbiAgICAgICAgaWYgKHR5cGVvZiBzZXJ2ZXJEYXRhWydVc2VyJ10gIT09ICd1bmRlZmluZWQnKVxuICAgICAgICAgIG5ld2NvbmZpZy51c2VyID0gc2VydmVyRGF0YVsnVXNlciddWydfdGV4dCddO1xuICAgICAgICBpZiAodHlwZW9mIHNlcnZlckRhdGFbJ1Bhc3MnXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBpZiAoc2VydmVyRGF0YVsnUGFzcyddWydfYXR0cmlidXRlcyddWydlbmNvZGluZyddID09ICdiYXNlNjQnKSB7XG4gICAgICAgICAgICBuZXdjb25maWcucGFzc3dvcmQgPSBCdWZmZXIuZnJvbShzZXJ2ZXJEYXRhWydQYXNzJ11bJ190ZXh0J10sIHNlcnZlckRhdGFbJ1Bhc3MnXVsnX2F0dHJpYnV0ZXMnXVsnZW5jb2RpbmcnXSkudG9TdHJpbmcoKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNlcnZlckRhdGFbJ1Bhc3MnXVsnX2F0dHJpYnV0ZXMnXVsnZW5jb2RpbmcnXSA9PSAnY3J5cHQnKSB7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnTm90IGltcGxlbWVudGVkIGltcG9ydCBmcm9tIEZpbGVaaWxsYSEnLCB7XG4gICAgICAgICAgICAgIGRldGFpbDogXCJGaWxlemlsbGEgaW1wb3J0IHdpdGggY3J5cHRlZCBwYXNzd29yZCBoYXMgbm90IGJlZW4gaW1wbGVtZW50ZWQhIFNhdmVkIGVtcHR5IHBhc3N3b3JkIGZvciBcIiArIG5ld2NvbmZpZy5uYW1lICsgXCIhXCIsXG4gICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChzZXJ2ZXJEYXRhWydQYXNzJ11bJ19hdHRyaWJ1dGVzJ11bJ2VuY29kaW5nJ10gPT0gJ3BsYWluJykge1xuICAgICAgICAgICAgbmV3Y29uZmlnLnBhc3N3b3JkID0gc2VydmVyRGF0YVsnUGFzcyddWydfdGV4dCddLCBzZXJ2ZXJEYXRhWydQYXNzJ11bJ19hdHRyaWJ1dGVzJ11bJ2VuY29kaW5nJ107XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdOb3QgcmVjb2duaXplZCBlbmNvZGluZyBtZXRob2QgZm9yIHBhc3N3b3JkIScsIHtcbiAgICAgICAgICAgICAgZGV0YWlsOiBcIkNvdWxkbid0IHJlY29nbml6ZSBwYXNzd29yZCB0eXBlIGZvciBzZXJ2ZXIgXCIgKyBuZXdjb25maWcubmFtZSArIFwiIGluIEZpbGVaaWxsYSBpbXBvcnQgZmlsZS4gU2F2ZWQgZW1wdHkgcGFzc3dvcmQuXCIsXG4gICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG5ld2NvbmZpZy5zZnRwID0gKHNlcnZlckRhdGFbJ1Byb3RvY29sJ11bJ190ZXh0J10gPT0gJzEnKTtcbiAgICAgICAgbmV3Y29uZmlnLnJlbW90ZSA9IHNlcnZlckRhdGFbJ1JlbW90ZURpciddWydfdGV4dCddIHx8ICcnO1xuXG4gICAgICAgIC8vIENvbnZlcnQgRmlsZVppbGxhIHBhdGhcbiAgICAgICAgaWYgKG5ld2NvbmZpZy5yZW1vdGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGxldCBwYXJ0cyA9IG5ld2NvbmZpZy5yZW1vdGUuc3BsaXQoJyAnKTtcbiAgICAgICAgICBsZXQgc2VnbWVudHMgPSBbJy8nXTtcblxuICAgICAgICAgIC8vIFJlbW92ZSB0eXBlIGFuZCBzdG9wXG4gICAgICAgICAgY29uc3QgdHlwZSA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgY29uc3Qgc3RvcCA9IHBhcnRzLnNoaWZ0KCk7XG5cbiAgICAgICAgICAvLyBwYXJzZSBzZWdtZW50c1xuICAgICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBzZWdtZW50TGVuZ3RoID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgICAgIHNlZ21lbnRzLnB1c2gocGFydHMuc2hpZnQoKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIG5ld2NvbmZpZy5yZW1vdGUgPSBub3JtYWxpemUoc2VnbWVudHMuam9pbignLycpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5ld2NvbmZpZy5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgICAgIGlmIChuZXdTZXJ2ZXIpIHtcbiAgICAgICAgICBTdG9yYWdlLmFkZFNlcnZlcihuZXdjb25maWcpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGRhdGFbJ0ZvbGRlciddICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGFbJ0ZvbGRlciddKSkge1xuICAgICAgICBkYXRhWydGb2xkZXInXSA9IFtkYXRhWydGb2xkZXInXV07XG4gICAgICB9XG4gICAgICBkYXRhWydGb2xkZXInXS5mb3JFYWNoKChmb2xkZXJEYXRhLCBpbmRleCkgPT4ge1xuICAgICAgICBsZXQgbmV3Y29uZmlnID0gU3RvcmFnZS5nZXRGb2xkZXJCeU5hbWUoZm9sZGVyRGF0YVsnX3RleHQnXSk7XG4gICAgICAgIGlmICh0eXBlb2YgbmV3Y29uZmlnID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIG5ld2NvbmZpZyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZm9sZGVyX2NvbmZpZykpO1xuICAgICAgICAgIG5ld2NvbmZpZy5uYW1lID0gZm9sZGVyRGF0YVsnX3RleHQnXTtcbiAgICAgICAgICBuZXdjb25maWcucGFyZW50ID0gcGFyZW50O1xuICAgICAgICAgIFN0b3JhZ2UuYWRkRm9sZGVyKG5ld2NvbmZpZyk7XG4gICAgICAgICAgY3JlYXRlZEZvbGRlcnMrKztcbiAgICAgICAgfVxuICAgICAgICBsZXQgaW1wb3J0ZWQgPSBzZWxmLmltcG9ydEZpbGVaaWxsYTMoZm9sZGVyRGF0YSwgbmV3Y29uZmlnLmlkKTtcbiAgICAgICAgY3JlYXRlZFNlcnZlcnMgKz0gaW1wb3J0ZWQuY3JlYXRlZFNlcnZlcnM7XG4gICAgICAgIHVwZGF0ZWRTZXJ2ZXJzICs9IGltcG9ydGVkLnVwZGF0ZWRTZXJ2ZXJzO1xuICAgICAgICBjcmVhdGVkRm9sZGVycyArPSBpbXBvcnRlZC5jcmVhdGVkRm9sZGVycztcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB7IGNyZWF0ZWRTZXJ2ZXJzOiBjcmVhdGVkU2VydmVycywgdXBkYXRlZFNlcnZlcnM6IHVwZGF0ZWRTZXJ2ZXJzLCBjcmVhdGVkRm9sZGVyczogY3JlYXRlZEZvbGRlcnMgfTtcbiAgfVxuXG4gIGltcG9ydEZ0cENvbmZpZyhkYXRhKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNyZWF0ZWRTZXJ2ZXJzID0gMDtcbiAgICBsZXQgdXBkYXRlZFNlcnZlcnMgPSAwO1xuXG4gICAgbGV0IG5hbWUgPSAoKHR5cGVvZiBkYXRhWyd1c2VyJ10gIT09ICd1bmRlZmluZWQnKSA/IChkYXRhWyd1c2VyJ10gKyAnQCcpIDogJycpICsgZGF0YVsnaG9zdCddO1xuICAgIGxldCBuZXdjb25maWcgPSBTdG9yYWdlLmdldFNlcnZlckJ5TmFtZShuYW1lKTtcbiAgICBpZiAodHlwZW9mIG5ld2NvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIG5ld2NvbmZpZyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc2VydmVyX2NvbmZpZykpO1xuICAgICAgY3JlYXRlZFNlcnZlcnMrKztcbiAgICB9IGVsc2Uge1xuICAgICAgdXBkYXRlZFNlcnZlcnMrKztcbiAgICB9XG4gICAgbmV3Y29uZmlnLm5hbWUgPSBuYW1lO1xuICAgIG5ld2NvbmZpZy5ob3N0ID0gZGF0YVsnaG9zdCddO1xuICAgIGlmICh0eXBlb2YgZGF0YVsncG9ydCddICE9PSAndW5kZWZpbmVkJylcbiAgICAgIG5ld2NvbmZpZy5wb3J0ID0gZGF0YVsncG9ydCddO1xuICAgIGlmICh0eXBlb2YgZGF0YVsndXNlciddICE9PSAndW5kZWZpbmVkJylcbiAgICAgIG5ld2NvbmZpZy51c2VyID0gZGF0YVsndXNlciddO1xuICAgIGlmICh0eXBlb2YgZGF0YVsncGFzcyddICE9PSAndW5kZWZpbmVkJylcbiAgICAgIG5ld2NvbmZpZy5wYXNzd29yZCA9IGRhdGFbJ3Bhc3MnXTtcbiAgICBuZXdjb25maWcuc2Z0cCA9IChkYXRhWydwcm90b2NvbCddID09ICdzZnRwJyk7XG4gICAgbmV3Y29uZmlnLnJlbW90ZSA9IGRhdGFbJ3JlbW90ZSddO1xuICAgIGlmIChjcmVhdGVkU2VydmVycyA+IDApIHtcbiAgICAgIFN0b3JhZ2UuYWRkU2VydmVyKG5ld2NvbmZpZyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgY3JlYXRlZFNlcnZlcnM6IGNyZWF0ZWRTZXJ2ZXJzLCB1cGRhdGVkU2VydmVyczogdXBkYXRlZFNlcnZlcnMsIGNyZWF0ZWRGb2xkZXJzOiAwIH07XG4gIH1cblxuICBpbXBvcnRQSFBTdG9ybShkYXRhKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNyZWF0ZWRTZXJ2ZXJzID0gMDtcbiAgICBsZXQgdXBkYXRlZFNlcnZlcnMgPSAwO1xuXG4gICAgZGF0YS5mb3JFYWNoKChzZXJ2ZXJEYXRhLCBpbmRleCkgPT4ge1xuICAgICAgbGV0IG5ld2NvbmZpZyA9IFN0b3JhZ2UuZ2V0U2VydmVyQnlOYW1lKHNlcnZlckRhdGFbJ19hdHRyaWJ1dGVzJ11bJ25hbWUnXSk7XG4gICAgICBsZXQgbmV3U2VydmVyID0gdHJ1ZTtcbiAgICAgIGlmICh0eXBlb2YgbmV3Y29uZmlnID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICBuZXdjb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNlcnZlcl9jb25maWcpKTtcbiAgICAgICAgY3JlYXRlZFNlcnZlcnMrKztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHVwZGF0ZWRTZXJ2ZXJzKys7XG4gICAgICAgIG5ld1NlcnZlciA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgbmV3Y29uZmlnLm5hbWUgPSBzZXJ2ZXJEYXRhWydfYXR0cmlidXRlcyddWyduYW1lJ107XG4gICAgICBuZXdjb25maWcuaG9zdCA9IHNlcnZlckRhdGFbJ2ZpbGVUcmFuc2ZlciddWydfYXR0cmlidXRlcyddWydob3N0J107XG4gICAgICBpZiAodHlwZW9mIHNlcnZlckRhdGFbJ2ZpbGVUcmFuc2ZlciddWydfYXR0cmlidXRlcyddWydwb3J0J10gIT09ICd1bmRlZmluZWQnKVxuICAgICAgICBuZXdjb25maWcucG9ydCA9IHNlcnZlckRhdGFbJ2ZpbGVUcmFuc2ZlciddWydfYXR0cmlidXRlcyddWydwb3J0J107XG4gICAgICBuZXdjb25maWcuc2Z0cCA9IChzZXJ2ZXJEYXRhWydmaWxlVHJhbnNmZXInXVsnX2F0dHJpYnV0ZXMnXVsnYWNjZXNzVHlwZSddID09ICdTRlRQJyk7XG4gICAgICBuZXdjb25maWcucmVtb3RlID0gc2VydmVyRGF0YVsnZmlsZVRyYW5zZmVyJ11bJ19hdHRyaWJ1dGVzJ11bJ3Jvb3RGb2xkZXInXSB8fCAnJztcbiAgICAgIGlmIChuZXdTZXJ2ZXIpIHtcbiAgICAgICAgU3RvcmFnZS5hZGRTZXJ2ZXIobmV3Y29uZmlnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB7IGNyZWF0ZWRTZXJ2ZXJzOiBjcmVhdGVkU2VydmVycywgdXBkYXRlZFNlcnZlcnM6IHVwZGF0ZWRTZXJ2ZXJzLCBjcmVhdGVkRm9sZGVyczogMCB9O1xuICB9XG59XG5tb2R1bGUuZXhwb3J0cyA9IEltcG9ydDtcbiJdfQ==